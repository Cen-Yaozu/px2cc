/**
 * Claude Command Toolkit - ä¸€ä½“åŒ–API
 *
 * è¾“å…¥Claude Codeå‘½ä»¤å‚æ•° â†’ ç›´æ¥è¿”å›å®‰è£…ç»“æœ
 */
import { writeFile } from './utils/file-utils.js';
import { join } from 'path';
/**
 * Claude Codeèµ„æºæ„å»ºå™¨ - ä¸€ä½“åŒ–API
 *
 * ğŸ“‹ æ–¹æ³•åˆ†ç»„è¯´æ˜:
 * ğŸš€ ä¸»è¦API(2ä¸ª) - å¯¹å¤–æä¾›çš„æ ¸å¿ƒæ¥å£
 * ğŸ” å‚æ•°éªŒè¯(2ä¸ª) - ç¡®ä¿ç”¨æˆ·è¾“å…¥åˆæ³•æ€§
 * ğŸ”§ å†…å®¹ç”Ÿæˆ(2ä¸ª) - å°†é…ç½®è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
 * ğŸ§¹ å·¥å…·æ–¹æ³•(1ä¸ª) - æä¾›é€šç”¨çš„åç§°æ¸…ç†åŠŸèƒ½
 *
 * æ¯ä¸ªä¸»è¦APIéƒ½éµå¾ªç›¸åŒçš„6æ­¥æµç¨‹ï¼šéªŒè¯â†’ç”Ÿæˆâ†’è·¯å¾„â†’å†™å…¥â†’æˆåŠŸâ†’é”™è¯¯å¤„ç†
 */
export class ClaudeCodeBuilder {
    /**
     * ğŸš€ ä¸»è¦API #1: åˆ›å»ºå¹¶å®‰è£…Claude Codeå‘½ä»¤ï¼ˆä¸€æ­¥å®Œæˆï¼‰
     *
     * è¿™æ˜¯å¯¹å¤–çš„æ ¸å¿ƒæ¥å£ï¼Œå°†ç”¨æˆ·çš„å‘½ä»¤é…ç½®è½¬æ¢ä¸ºClaude Codeå¯ç”¨çš„å‘½ä»¤æ–‡ä»¶
     *
     * @param options å‘½ä»¤å‚æ•° - ç”¨æˆ·æä¾›çš„æ‰€æœ‰é…ç½®é€‰é¡¹
     * @returns å®‰è£…ç»“æœ - åŒ…å«æˆåŠŸçŠ¶æ€ã€æ–‡ä»¶è·¯å¾„ã€é”™è¯¯ä¿¡æ¯ç­‰
     */
    static async createCommand(options) {
        try {
            // 1. ğŸ” éªŒè¯å‚æ•° - è°ƒç”¨validateOptions()ç¡®ä¿è¾“å…¥åˆæ³•
            const validation = this.validateOptions(options);
            if (!validation.valid) {
                return {
                    success: false,
                    commandName: options.name,
                    message: 'å‚æ•°éªŒè¯å¤±è´¥',
                    error: validation.errors.join(', ')
                };
            }
            // 2. ğŸ“ ç”Ÿæˆå‘½ä»¤å†…å®¹ - è°ƒç”¨generateContent()åˆ›å»ºæ ‡å‡†frontmatteræ ¼å¼
            const commandContent = this.generateContent(options);
            // 3. ğŸ“ ç¡®å®šæ–‡ä»¶è·¯å¾„ - è°ƒç”¨sanitizeName()ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
            const baseDir = options.targetDir || './.claude';
            const commandsDir = join(baseDir, 'commands');
            const commandName = this.sanitizeName(options.name);
            const filePath = join(commandsDir, `${commandName}.md`);
            // 4. ğŸ’¾ å®‰è£…åˆ°æ–‡ä»¶ç³»ç»Ÿ - è°ƒç”¨writeFile()è‡ªåŠ¨åˆ›å»ºç›®å½•å¹¶å†™å…¥æ–‡ä»¶
            await writeFile(filePath, commandContent);
            // 5. âœ… è¿”å›æˆåŠŸç»“æœ
            return {
                success: true,
                commandName,
                filePath,
                message: `å‘½ä»¤ /${commandName} å®‰è£…æˆåŠŸ`,
                generatedContent: commandContent
            };
        }
        catch (error) {
            // 6. âŒ å¤„ç†é”™è¯¯ - ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ ¼å¼åŒ–
            return {
                success: false,
                commandName: this.sanitizeName(options.name),
                message: 'å®‰è£…å¤±è´¥',
                error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
            };
        }
    }
    /**
     * ğŸš€ ä¸»è¦API #2: åˆ›å»ºå¹¶å®‰è£…Claude Code Subagentï¼ˆä¸€æ­¥å®Œæˆï¼‰
     *
     * è¿™æ˜¯å¯¹å¤–çš„æ ¸å¿ƒæ¥å£ï¼Œå°†ç”¨æˆ·çš„subagenté…ç½®è½¬æ¢ä¸ºClaude Codeå¯ç”¨çš„ä»£ç†æ–‡ä»¶
     *
     * @param options subagentå‚æ•° - ç”¨æˆ·æä¾›çš„ä»£ç†é…ç½®é€‰é¡¹
     * @returns å®‰è£…ç»“æœ - åŒ…å«æˆåŠŸçŠ¶æ€ã€æ–‡ä»¶è·¯å¾„ã€é”™è¯¯ä¿¡æ¯ç­‰
     */
    static async createSubagent(options) {
        try {
            // 1. ğŸ” éªŒè¯å‚æ•° - è°ƒç”¨validateSubagentOptions()ç¡®ä¿è¾“å…¥åˆæ³•
            const validation = this.validateSubagentOptions(options);
            if (!validation.valid) {
                return {
                    success: false,
                    subagentName: options.name,
                    message: 'å‚æ•°éªŒè¯å¤±è´¥',
                    error: validation.errors.join(', ')
                };
            }
            // 2. ğŸ“ ç”Ÿæˆsubagentå†…å®¹ - è°ƒç”¨generateSubagentContent()åˆ›å»ºä»£ç†æ ¼å¼
            const subagentContent = this.generateSubagentContent(options);
            // 3. ğŸ“ ç¡®å®šæ–‡ä»¶è·¯å¾„ - è°ƒç”¨sanitizeName()ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
            const baseDir = options.targetDir || './.claude';
            const agentsDir = join(baseDir, 'agents');
            const subagentName = this.sanitizeName(options.name);
            const filePath = join(agentsDir, `${subagentName}.md`);
            // 4. ğŸ’¾ å®‰è£…åˆ°æ–‡ä»¶ç³»ç»Ÿ - è°ƒç”¨writeFile()è‡ªåŠ¨åˆ›å»ºç›®å½•å¹¶å†™å…¥æ–‡ä»¶
            await writeFile(filePath, subagentContent);
            // 5. âœ… è¿”å›æˆåŠŸç»“æœ
            return {
                success: true,
                subagentName,
                filePath,
                message: `Subagent ${subagentName} å®‰è£…æˆåŠŸ`,
                generatedContent: subagentContent
            };
        }
        catch (error) {
            // 6. âŒ å¤„ç†é”™è¯¯ - ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ ¼å¼åŒ–
            return {
                success: false,
                subagentName: this.sanitizeName(options.name),
                message: 'å®‰è£…å¤±è´¥',
                error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
            };
        }
    }
    /**
     * ğŸ”§ å†…éƒ¨æ–¹æ³•: ç”Ÿæˆå‘½ä»¤å†…å®¹ - ä¸º createCommand() API æœåŠ¡
     *
     * å°†ç”¨æˆ·çš„å‘½ä»¤é€‰é¡¹è½¬æ¢ä¸ºClaude Codeæ ‡å‡†çš„frontmatteræ ¼å¼æ–‡ä»¶
     * è¿™æ˜¯ createCommand() ç¬¬2æ­¥è°ƒç”¨çš„æ ¸å¿ƒæ ¼å¼åŒ–æ–¹æ³•
     */
    static generateContent(options) {
        // ç”Ÿæˆå¸¦frontmatterçš„Claude Codeæ ‡å‡†æ ¼å¼
        let content = '---\n';
        // å¿…éœ€å­—æ®µï¼šæè¿°
        const description = options.description || `${options.name} å‘½ä»¤`;
        content += `description: "${description}"\n`;
        // å¯é€‰å­—æ®µ
        if (options.argumentHint) {
            content += `argument-hint: "${options.argumentHint}"\n`;
        }
        if (options.model) {
            content += `model: "${options.model}"\n`;
        }
        if (options.allowedTools && options.allowedTools.length > 0) {
            content += 'allowed-tools:\n';
            for (const tool of options.allowedTools) {
                content += `  - "${tool}"\n`;
            }
        }
        // è‡ªå®šä¹‰å­—æ®µ
        if (options.customFields) {
            for (const [key, value] of Object.entries(options.customFields)) {
                if (Array.isArray(value)) {
                    content += `${key}:\n`;
                    for (const item of value) {
                        content += `  - "${item}"\n`;
                    }
                }
                else {
                    content += `${key}: "${value}"\n`;
                }
            }
        }
        content += '---\n\n';
        content += options.content.trim() + '\n';
        return content;
    }
    /**
     * ğŸ” å†…éƒ¨æ–¹æ³•: éªŒè¯å‘½ä»¤è¾“å…¥å‚æ•° - ä¸º createCommand() API æœåŠ¡
     *
     * æ£€æŸ¥ç”¨æˆ·æä¾›çš„å‘½ä»¤é€‰é¡¹æ˜¯å¦ç¬¦åˆè¦æ±‚
     * è¿™æ˜¯ createCommand() ç¬¬1æ­¥è°ƒç”¨çš„å‚æ•°æ ¡éªŒæ–¹æ³•
     */
    static validateOptions(options) {
        const errors = [];
        if (!options.name || typeof options.name !== 'string') {
            errors.push('å‘½ä»¤åç§°æ˜¯å¿…éœ€çš„');
        }
        else if (!/^[a-zA-Z0-9\u4e00-\u9fa5_-]+$/.test(options.name)) {
            errors.push('å‘½ä»¤åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦');
        }
        if (!options.content || typeof options.content !== 'string') {
            errors.push('å‘½ä»¤å†…å®¹æ˜¯å¿…éœ€çš„');
        }
        else if (options.content.trim().length === 0) {
            errors.push('å‘½ä»¤å†…å®¹ä¸èƒ½ä¸ºç©º');
        }
        return { valid: errors.length === 0, errors };
    }
    /**
     * ğŸ” å†…éƒ¨æ–¹æ³•: éªŒè¯Subagentè¾“å…¥å‚æ•° - ä¸º createSubagent() API æœåŠ¡
     *
     * æ£€æŸ¥ç”¨æˆ·æä¾›çš„subagenté€‰é¡¹æ˜¯å¦ç¬¦åˆè¦æ±‚
     * è¿™æ˜¯ createSubagent() ç¬¬1æ­¥è°ƒç”¨çš„å‚æ•°æ ¡éªŒæ–¹æ³•
     */
    static validateSubagentOptions(options) {
        const errors = [];
        if (!options.name || typeof options.name !== 'string') {
            errors.push('Subagentåç§°æ˜¯å¿…éœ€çš„');
        }
        else if (!/^[a-zA-Z0-9\u4e00-\u9fa5_-]+$/.test(options.name)) {
            errors.push('Subagentåç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦');
        }
        if (!options.description || typeof options.description !== 'string') {
            errors.push('Subagentæè¿°æ˜¯å¿…éœ€çš„');
        }
        else if (options.description.trim().length === 0) {
            errors.push('Subagentæè¿°ä¸èƒ½ä¸ºç©º');
        }
        if (!options.content || typeof options.content !== 'string') {
            errors.push('Subagentå†…å®¹æ˜¯å¿…éœ€çš„');
        }
        else if (options.content.trim().length === 0) {
            errors.push('Subagentå†…å®¹ä¸èƒ½ä¸ºç©º');
        }
        return { valid: errors.length === 0, errors };
    }
    /**
     * ğŸ”§ å†…éƒ¨æ–¹æ³•: ç”ŸæˆSubagentå†…å®¹ - ä¸º createSubagent() API æœåŠ¡
     *
     * å°†ç”¨æˆ·çš„subagenté€‰é¡¹è½¬æ¢ä¸ºClaude Codeæ ‡å‡†çš„ä»£ç†æ–‡ä»¶æ ¼å¼
     * è¿™æ˜¯ createSubagent() ç¬¬2æ­¥è°ƒç”¨çš„æ ¸å¿ƒæ ¼å¼åŒ–æ–¹æ³•
     */
    static generateSubagentContent(options) {
        // ç”Ÿæˆæ ‡å‡†Claude Code Subagentæ ¼å¼
        let content = '---\n';
        // å¿…éœ€å­—æ®µ
        content += `name: ${options.name}\n`;
        content += `description: ${options.description}\n`;
        // å¯é€‰å·¥å…·å­—æ®µ
        if (options.tools && options.tools.length > 0) {
            content += `tools: ${options.tools.join(', ')}\n`;
        }
        content += '---\n\n';
        content += options.content.trim() + '\n';
        return content;
    }
    /**
     * ğŸ§¹ å†…éƒ¨æ–¹æ³•: æ¸…ç†å‘½ä»¤åç§° - ä¸ºä¸¤ä¸ªä¸»è¦APIæœåŠ¡
     *
     * å°†ç”¨æˆ·è¾“å…¥çš„åç§°è½¬æ¢ä¸ºå®‰å…¨çš„æ–‡ä»¶åæ ¼å¼
     * è¿™æ˜¯ä¸¤ä¸ªAPIç¬¬3æ­¥è°ƒç”¨çš„æ–‡ä»¶åè§„èŒƒåŒ–æ–¹æ³•ï¼Œç¡®ä¿ç”Ÿæˆçš„æ–‡ä»¶åç¬¦åˆç³»ç»Ÿè¦æ±‚
     */
    static sanitizeName(name) {
        return name
            .toLowerCase()
            .replace(/[^a-zA-Z0-9\u4e00-\u9fa5-]/g, '-') // æ”¯æŒä¸­æ–‡
            .replace(/-+/g, '-')
            .replace(/^-+|-+$/g, '');
    }
}
// é»˜è®¤å¯¼å‡º
export default ClaudeCodeBuilder;
